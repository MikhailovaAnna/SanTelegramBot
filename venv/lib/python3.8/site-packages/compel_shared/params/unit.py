from typing import Dict, List

from dataclasses import field
from marshmallow_dataclass import dataclass
from marshmallow import fields

from compel_shared import load_yml
from compel_shared.params import load_template_config_defaults
from compel_shared.schema import MultilangField, Decimal, DecimalField, pick_field_data, MongoIDSchema


@dataclass
class UnitConfig:
    units: Dict[str, List[str]] = field(default=None, metadata=dict(
        marshmallow_field=MultilangField(
            fields.List(fields.Str(), as_textarea=True), title='Единицы измерения',
            description='''
Перечисляются все возможные варианты записи данной единицы измерения.

Если шаблон применяется для распознавания, то первый вариант используется также для выдачи единиц в API каталога.             
''')
    ))
    precision: int = field(default=None, metadata=dict(
        title='Точность',
        description='Количество знаков до которого округляется значение',
    ))
    default_multiplier: Decimal = field(default=None, metadata=dict(
        marshmallow_field=DecimalField(
            title='Множитель по умолчанию',
            description='Значения у которых не удалось выделить единицы измерения умножаются на этот множитель',
            enum_key='multipliers',
            allow_none=True,
        )
    ))


@dataclass(base_schema=MongoIDSchema)
class UnitTemplate(UnitConfig):
    id: str = field(default=None, metadata=pick_field_data(MongoIDSchema, 'id', data_key='_id'))
    name: str = field(default=None, metadata=dict(title='Название',
                                                  required_on_create=True,
                                                  description='Название шаблона'))
    provider: str = field(default=None, metadata=dict(is_hidden=True))

    @property
    def unit_names(self):
        units = []
        if self.units:
            for lang in self.units:
                units.extend(self.units[lang])
        return list(set(units))

    @staticmethod
    def load_defaults():
        data = load_yml(__file__, 'units.yml')
        return load_template_config_defaults(data)

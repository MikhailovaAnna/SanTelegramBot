import asyncio
import logging

from nats.aio.client import Client as NATS
from shortid import ShortId
from stan.aio.client import Client as STAN

from compel_shared.config import NATS_SERVERS

nats = NATS()
stan = STAN()

log = logging.getLogger(__name__)


async def init_nats(app, client_id):
    async def connect():
        await stan.connect('compel', f'{client_id}-{ShortId().generate()}', nats=nats, conn_lost_cb=on_lost_connect)

    async def on_lost_connect(err):
        log.error(f'Connection lost : {err}, reconnecting')
        await asyncio.sleep(1, loop=app.loop)
        await connect()
        log.info(f'Connected to NATS at {NATS_SERVERS}')

    await nats.connect(io_loop=app.loop, servers=NATS_SERVERS.split(','))
    await  connect()
    return stan
